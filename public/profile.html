<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Armory Profile</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family:sans-serif; background:#0b1625; color:#fff; padding:24px; }
    .header { display:flex; align-items:center; gap:12px; margin-bottom:24px; }
    #userpic { width:48px; height:48px; border-radius:50%; }
    #btnLogout, #btnHome { margin-left:auto; padding:8px 16px; border:none; background:#f96302; color:#fff; cursor:pointer; }
    form { display:none; flex-direction:column; gap:12px; max-width:360px; background:rgba(255,255,255,0.05); padding:24px; border-radius:8px; }
    form.active { display:flex; }
    label { display:flex; flex-direction:column; font-size:14px; }
    input { padding:8px; margin-top:4px; border:none; border-radius:4px; }
    button.save { background:#3e8e3e; color:#fff; border:none; padding:10px; cursor:pointer; border-radius:4px; }
  </style>

  <!-- 1) env.js first -->
  <script src="/env.js"></script>

  <!-- 2) Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="header">
    <img id="userpic" hidden>
    <span id="username"></span>
    <button id="btnHome" hidden onclick="location.href='index.html'">Home</button>
    <button id="btnLogout" hidden>Log Out</button>
  </div>

  <form id="profileForm">
    <h2>My Profile</h2>
    <label>
      Display Name:
      <input id="displayName" type="text">
    </label>
    <label>
      Favorite Color:
      <input id="favoriteColor" type="color">
    </label>
    <button type="submit" class="save">Save Profile</button>
  </form>

  <script>
    // ── Init Firebase ───────────────────────────────────────────
    const cfg = window.__env__;
    firebase.initializeApp({
      apiKey:            cfg.FIREBASE_API_KEY,
      authDomain:        cfg.FIREBASE_AUTH_DOMAIN,
      projectId:         cfg.FIREBASE_PROJECT_ID,
      storageBucket:     cfg.FIREBASE_STORAGE_BUCKET,
      messagingSenderId: cfg.FIREBASE_MESSAGING_SENDER_ID,
      appId:             cfg.FIREBASE_APP_ID
    });
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ── Protect + load profile ───────────────────────────────────
    auth.onAuthStateChanged(async user => {
      if (!user) return location.href = '/login.html';

      // show header
      document.getElementById('username').textContent = user.displayName || user.email;
      const pic = document.getElementById('userpic');
      pic.src    = user.photoURL || '/images/default-avatar.png';
      pic.hidden = false;
      document.getElementById('btnLogout').hidden = false;
      document.getElementById('btnHome').hidden   = false;

      // load Firestore profile doc
      const ref = db.collection('profiles').doc(user.uid);
      const snap = await ref.get();
      if (snap.exists) {
        const data = snap.data();
        document.getElementById('displayName').value   = data.displayName || '';
        document.getElementById('favoriteColor').value = data.color       || '#ffffff';
      }
      document.getElementById('profileForm').classList.add('active');

      // logout
      document.getElementById('btnLogout').onclick = () => auth.signOut().then(()=> location.href='/login.html');

      // save changes
      document.getElementById('profileForm').onsubmit = async e => {
        e.preventDefault();
        await ref.set({
          displayName:   document.getElementById('displayName').value,
          color:         document.getElementById('favoriteColor').value
        }, { merge:true });
        alert('Profile saved!');
      };
    });
  </script>
</body>
</html>
