<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>User Profile</title>
  <link rel="stylesheet" href="profile.css">
</head>
<body>
  <header>
    <h1 id="lblName">Loadingâ€¦</h1>
    <img id="imgAvatar" src="" alt="Avatar" hidden>
  </header>

  <section>
    <h2>Community Builds</h2>
    <div id="buildsContainer" class="builds-grid">
      <!-- builds will go here -->
    </div>
  </section>

  <script type="module">
    import { db } from './firebase-config.js';
    import {
      doc, getDoc,
      collection, query, where, orderBy, getDocs
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    (async function() {
      const params = new URLSearchParams(location.search);
      const uid = params.get('uid');
      if (!uid) return document.body.textContent = 'No user specified.';

      // --- Fetch and show user metadata ---
      const profileRef = doc(db, 'profiles', uid);
      const profileSnap = await getDoc(profileRef);
      if (profileSnap.exists()) {
        const { displayName, color } = profileSnap.data();
        document.getElementById('lblName').textContent = displayName || 'Unnamed Hero';
        const avatar = document.getElementById('imgAvatar');
        avatar.src      = profileSnap.data().avatarURL || '/images/default-avatar.png';
        avatar.hidden   = false;
        if (color) document.body.style.setProperty('--accent', color);
      } else {
        document.getElementById('lblName').textContent = 'Unknown User';
      }

      // --- Query their community builds ---
      const buildsQ = query(
        collection(db, 'communityBuilds'),
        where('ownerId','==', uid),
        orderBy('createdAt','desc')
      );
      const snap = await getDocs(buildsQ);
      const cont = document.getElementById('buildsContainer');

      snap.forEach(docSnap => {
        const b = docSnap.data();
        const card = document.createElement('div');
        card.className = 'build-card';
        card.innerHTML = `
          <div class="card-header">
            <img src="/images/avatars/${b.heroId}.png" alt="${b.heroName}">
            <h3>${b.heroName}</h3>
          </div>
          <div class="card-body">
            <div class="squares">
              ${b.powerIds.map(id =>
                `<div class="square"><img src="/images/abilities/${id}.png"></div>`
              ).join('')}
            </div>
            <div class="circles">
              ${b.itemIds.map(id =>
                `<div class="circle"><img src="/images/abilities/${id}.png"></div>`
              ).join('')}
            </div>
            <div class="cost">Total: ${b.totalCost.toLocaleString()}</div>
          </div>`;
        cont.appendChild(card);
      });

      if (snap.empty) {
        cont.textContent = 'No builds yet.';
      }
    })();
  </script>
</body>
</html>
