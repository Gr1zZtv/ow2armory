<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Armory Home</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      visibility: hidden; /* wait until auth state is known */
      font-family: sans-serif;
      padding: 20px;
    }
    nav { margin-bottom: 20px; }
    nav button { padding: 8px 16px; margin: 0 8px; }
    #userName { margin-left: 16px; font-weight: bold; }
    #userPicture { width:32px; height:32px; border-radius:50%; margin-left:8px; vertical-align:middle; }
    #profileSection { 
      background:#fff; padding:16px; border-radius:8px; 
      box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:24px; width:300px;
    }
    #profileSection h2 { margin-top:0; }
    #profileSection label { display:block; margin:8px 0; }
    #profileSection input { margin-left:8px; }
    .container { text-align:center; margin-top:auto; }
    .container button { padding:12px 24px; margin:0 10px; }
  </style>

  <!-- Auth0 SPA SDK -->
  <script src="https://cdn.auth0.com/js/auth0-spa-js/1.19/auth0-spa-js.production.js"></script>
  <script>
    let auth0;
    window.onload = async () => {
      // 1) initialize
      auth0 = await createAuth0Client({
        domain:        'dev-bx2itlkpy8ayes2m.us.auth0.com',
        client_id:     'sUgQncsj6HR0JA9urvxKhLqdDkj4VqJn',
        cacheLocation: 'localstorage',
        useRefreshTokens: true,
        audience:      'https://my-armory-api',
        redirect_uri:  window.location.origin    // <-- only origin
      });

      // 2) handle callback
      if (window.location.search.includes('code=') && window.location.search.includes('state=')) {
        await auth0.handleRedirectCallback();
        // strip code & state from URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      // 3) check login state
      const isAuthenticated = await auth0.isAuthenticated();

      // 4) wire up buttons
      document.getElementById('btnLogin').onclick = () =>
        auth0.loginWithRedirect({ redirect_uri: window.location.origin });
      document.getElementById('btnSignup').onclick = () =>
        auth0.loginWithRedirect({ 
          redirect_uri: window.location.origin, 
          screen_hint: 'signup' 
        });
      document.getElementById('btnLogout').onclick = () =>
        auth0.logout({ returnTo: window.location.origin });

      // 5) toggle UI
      document.getElementById('btnLogin').hidden      = isAuthenticated;
      document.getElementById('btnSignup').hidden     = isAuthenticated;
      document.getElementById('btnLogout').hidden     = !isAuthenticated;
      document.getElementById('profileSection').hidden= !isAuthenticated;
      document.body.style.visibility = 'visible';

      if (isAuthenticated) {
        // show user info
        const user = await auth0.getUser();
        document.getElementById('userName').textContent = user.name;
        const pic = document.getElementById('userPicture');
        pic.src = user.picture;
        pic.hidden = false;

        // load profile metadata
        const token   = await auth0.getTokenSilently();
        const profile = await fetch('/api/profile',{
          headers:{Authorization:`Bearer ${token}`}
        }).then(r=>r.json());

        document.getElementById('profileDisplayName').value = profile.displayName||'';
        document.getElementById('profileColor').value       = profile.color||'#ffffff';

        // save form
        document.getElementById('profileForm').onsubmit = async e => {
          e.preventDefault();
          const updates = {
            displayName:document.getElementById('profileDisplayName').value,
            color:      document.getElementById('profileColor').value
          };
          const res = await fetch('/api/profile', {
            method:'PATCH',
            headers:{
              'Content-Type':'application/json',
              Authorization:`Bearer ${token}`
            },
            body:JSON.stringify(updates)
          });
          alert(res.ok ? 'Profile saved!' : 'Error saving profile');
        };
      }
    };
  </script>
</head>

<body>
  <nav>
    <button id="btnLogin">Log In</button>
    <button id="btnSignup">Sign Up</button>
    <button id="btnLogout">Log Out</button>
    <span id="userName"></span>
    <img id="userPicture" alt="Profile Picture" hidden>
  </nav>

  <section id="profileSection">
    <h2>My Profile</h2>
    <form id="profileForm">
      <label>
        Display Name:
        <input id="profileDisplayName" type="text">
      </label>
      <label>
        Favorite Color:
        <input id="profileColor" type="color">
      </label>
      <button type="submit">Save Profile</button>
    </form>
  </section>

  <div class="container">
    <button onclick="location.href='viewer.html'">Go to Viewer</button>
    <button onclick="location.href='admin.html'">Go to Admin</button>
  </div>
</body>
</html>